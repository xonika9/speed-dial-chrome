#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const ROOT_DIR = path.resolve(path.dirname(new URL(import.meta.url).pathname), '..');
const SOURCE_FILE = path.join(ROOT_DIR, 'docs/legacy/background.legacy.js');
const OUTPUT_FILE = path.join(ROOT_DIR, 'src/ui/runtime/legacy-initializers.js');
const NAMES_OUTPUT_FILE = path.join(ROOT_DIR, 'src/ui/runtime/legacy-initializer-names.js');

function extractTopLevelChunks(source) {
  const chunks = [];
  let depth = 0;
  let start = -1;

  for (let i = 0; i < source.length; i += 1) {
    const ch = source[i];

    if (ch === '{') {
      if (depth === 0) {
        start = i;
      }
      depth += 1;
      continue;
    }

    if (ch === '}') {
      depth -= 1;
      if (depth === 0 && start >= 0) {
        chunks.push(source.slice(start, i + 1));
        start = -1;
      }
    }
  }

  return chunks;
}

function buildGeneratedContent(initChunks, initNames) {
  const header = [
    '/**',
    ' * AUTO-GENERATED FILE. DO NOT EDIT.',
    ' * Generated by scripts/generate-legacy-ui-runtime.mjs',
    ' *',
    ' * This classic script contains legacy UI initializer blocks extracted from',
    ' * docs/legacy/background.legacy.js and exposes them via window.__MV3_LEGACY_INITIALIZERS__.',
    ' */',
    ''
  ].join('\n');

  const mapEntries = initNames
    .map(name => `    ${JSON.stringify(name)}: typeof ${name} === 'function' ? ${name} : undefined`)
    .join(',\n');

  return `${header}(function () {\n${initChunks.join('\n')}\n\n  window.__MV3_LEGACY_INITIALIZERS__ = Object.freeze({\n${mapEntries}\n  });\n})();\n`;
}

function buildNamesModuleContent(initNames) {
  const namesList = initNames.map(name => `  ${JSON.stringify(name)}`).join(',\n');

  return [
    '/**',
    ' * AUTO-GENERATED FILE. DO NOT EDIT.',
    ' * Generated by scripts/generate-legacy-ui-runtime.mjs',
    ' */',
    '',
    'export const LEGACY_INITIALIZER_NAMES = Object.freeze([',
    namesList,
    ']);',
    '',
    'const LEGACY_INITIALIZER_SET = new Set(LEGACY_INITIALIZER_NAMES);',
    '',
    'export function hasLegacyInitializer(name) {',
    "  if (typeof name !== 'string' || name.length === 0) {",
    '    return false;',
    '  }',
    "  const normalized = name.startsWith('init') ? name : `init${name}`;",
    '  return LEGACY_INITIALIZER_SET.has(normalized);',
    '}',
    '',
    'export default {',
    '  LEGACY_INITIALIZER_NAMES,',
    '  hasLegacyInitializer',
    '};',
    ''
  ].join('\n');
}

function main() {
  const source = fs.readFileSync(SOURCE_FILE, 'utf8');
  const chunks = extractTopLevelChunks(source);

  const initChunks = chunks.filter(chunk => /function\s+init[A-Za-z0-9_]+\s*\(window\)/.test(chunk));
  const initNames = Array.from(
    new Set(
      initChunks.flatMap(chunk =>
        Array.from(chunk.matchAll(/function\s+(init[A-Za-z0-9_]+)\s*\(window\)/g), match => match[1])
      )
    )
  ).sort();

  if (initChunks.length === 0 || initNames.length === 0) {
    throw new Error('No legacy UI init blocks were extracted from docs/legacy/background.legacy.js');
  }

  const generatedContent = buildGeneratedContent(initChunks, initNames);
  const generatedNamesModule = buildNamesModuleContent(initNames);

  const checkMode = process.argv.includes('--check');

  if (checkMode) {
    const currentContent = fs.existsSync(OUTPUT_FILE) ? fs.readFileSync(OUTPUT_FILE, 'utf8') : '';
    const currentNames = fs.existsSync(NAMES_OUTPUT_FILE) ? fs.readFileSync(NAMES_OUTPUT_FILE, 'utf8') : '';

    if (currentContent !== generatedContent || currentNames !== generatedNamesModule) {
      console.error('Legacy UI runtime artifacts are out of date.');
      console.error('Run: node scripts/generate-legacy-ui-runtime.mjs');
      process.exit(1);
    }

    console.log(`Legacy UI runtime is up-to-date (${initNames.length} init functions)`);
    return;
  }

  fs.writeFileSync(OUTPUT_FILE, generatedContent);
  fs.writeFileSync(NAMES_OUTPUT_FILE, generatedNamesModule);
  console.log(`Generated legacy UI runtime (${initNames.length} init functions)`);
}

main();
